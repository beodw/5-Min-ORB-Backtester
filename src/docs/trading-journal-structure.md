# Trading Journal Data Structure for Analysis

This document outlines the structure of the data as it is stored in your Firebase Firestore database. Understanding this structure is essential for performing meaningful analysis on your backtested trades.

## High-Level Structure: Firestore

Your trading journal data is organized within Firestore, a NoSQL cloud database. The structure is designed to be both scalable and easy to query.

-   **Collection**: All trade data is stored in a single top-level collection named `trades`. A collection is simply a container for documents.

-   **Documents**: Each individual trade you log from the application is stored as a separate **document** within the `trades` collection. The unique ID for each document is automatically generated by Firestore. This means that one complete trade, from entry to exit, is a single, self-contained unit in the database.

## Trade Document Fields

Each document within the `trades` collection contains several fields that describe the trade's parameters and its entire lifecycle.

| Field Name      | Data Type            | Description                                                                                                                                      |
| :-------------- | :------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------- |
| `tradeId`       | `string`             | A unique identifier for the trade, generated from the entry timestamp (e.g., `"2024-09-03T18:30:00.000Z"`).                                    |
| `entryPrice`    | `number`             | The price at which the trade was entered.                                                                                                        |
| `stopLossPrice` | `number`             | The price at which the stop loss was set for this trade.                                                                                         |
| `createdAt`     | `Firestore Timestamp`| A server-generated timestamp indicating exactly when the trade document was written to the database.                                               |
| `entryDate`     | `Firestore Timestamp`| The precise timestamp for when the trade was initiated on the chart.                                                                               |
| `log`           | `array`              | An array of objects, where each object represents one candle (or time interval, e.g., 1 minute) in the life of the trade. See details below.        |

### The `log` Array: The Heart of the Analysis

The `log` field is an array that contains a chronological record of the trade's performance, candle by candle. Each entry in the array is an object with the following structure:

| Field Name           | Data Type | Description                                                                                                   |
| :------------------- | :-------- | :------------------------------------------------------------------------------------------------------------ |
| `Timestamp`          | `string`  | The ISO 8601 timestamp for that specific candle (e.g., `"2024-09-03T18:31:00.000Z"`).                          |
| `CandleNumber`       | `number`  | The sequence number of the candle since the trade entry (e.g., `1`, `2`, `3`, ...).                            |
| `CurrentPrice_Close` | `number`  | The closing price of the instrument at the end of this candle.                                                |
| `MFE_R`              | `number`  | **Maximum Favorable Excursion (in R-multiples)**. The peak profit the trade reached, measured in multiples of the initial risk. |
| `MAE_R`              | `number`  | **Maximum Adverse Excursion (in R-multiples)**. The maximum unrealized loss (drawdown) the trade experienced, measured in multiples of initial risk. |
| `DrawdownFromMFE_R`  | `number`  | The drawdown from the peak profit (MFE), measured in R-multiples. This is crucial for analyzing trail-stop strategies. |
| `Trade Status`       | `string`  | The status of the trade at this candle. It will be `"Active"`, `"StopLoss"` (if the SL was hit), or `"EndOfData"` (if the trade was still active when the data ran out). |

## How the Report Download Works (Legacy CSV Method)

This section describes how the report generation in the Backtester section functions. This process transforms the visual trades you place on the chart into a detailed, candle-by-candle dataset that is perfect for deep analysis. It is all handled by the `generateTradeLog` function within the application.

1.  **Initiation**: When you have placed one or more Risk/Reward tools on the chart in the "Backtester" tab, you would click the button for downloading the report.

2.  **Trade Simulation**: The application then iterates through each Risk/Reward tool you've placed. For each tool, it runs a full simulation:
    *   It finds the exact candle on the chart where your trade entry was placed.
    *   It then proceeds forward, one candle at a time, until the end of the imported price data or until the trade is stopped out.

3.  **Data Calculation (Per Candle)**: For every single candle in the trade's life, the application calculates and records a snapshot of the trade's state. This is where it computes the critical analytical metrics:
    *   **Maximum Favorable Excursion (MFE_R)**: It checks if the current candle's high (for longs) or low (for shorts) has made a new peak profit for the trade.
    *   **Maximum Adverse Excursion (MAE_R)**: It checks if the current candle has created a new maximum drawdown.
    *   **Drawdown from MFE (DrawdownFromMFE_R)**: It calculates how far the current closing price has pulled back from the absolute peak profit.
    *   **Trade Status**: It determines if the trade is still 'Active', has hit its 'StopLoss', or has reached the 'EndOfData'.

4.  **CSV Generation**: Once all tools have been simulated, the application compiles all the per-candle log entries from all trades into a single CSV file and triggers a download in your browser.

### Structure of the Report

The generated CSV file has a clear, structured format, with each row representing a single candle in the life of a trade. This "long format" data is ideal for use in analytical tools like Python's pandas, R, or even Excel Pivot Tables.

Here are the columns in the report and what they mean:

| Column Name | Description |
| :--- | :--- |
| **TradeID** | A unique identifier for the trade, based on its entry timestamp. All rows belonging to the same trade will share this ID. |
| **Timestamp** | The specific timestamp for that individual candle in the log. |
| **CandleNumber** | The sequence number of the candle since the trade was entered (e.g., 1, 2, 3...). |
| **EntryPrice** | The price at which the trade was initiated. This is constant for all rows of a given trade. |
| **StopLossPrice** | The original stop loss price set for the trade. Also constant for all rows of a trade. |
| **CurrentPrice_Close** | The closing price of the instrument at the end of this specific candle. |
| **MFE_R** | **Maximum Favorable Excursion (R-multiple)**. The *peak* profit the trade had reached up to this point in time, measured in multiples of the initial risk. |
| **MAE_R** | **Maximum Adverse Excursion (R-multiple)**. The *maximum* drawdown the trade had experienced up to this point, measured in R-multiples. Capped at 1.0. |
| **DrawdownFromMFE_R**| **Drawdown from MFE (R-multiple)**. How far the current close has pulled back from the trade's peak profit (MFE), measured in R-multiples. |
| **Trade Status** | The status of the trade at this candle: `Active`, `StopLoss`, or `EndOfData`. |

---
## Analytical Nuances and Practical Applications

To get the most out of this data, consider the following:

### 1. Risk (R) Is the Unit of Measurement
The key performance metrics (`MFE_R`, `MAE_R`, `DrawdownFromMFE_R`) are normalized by risk. **Risk (R)** is defined as the absolute difference between the `entryPrice` and the `stopLossPrice`. This is a powerful concept because it allows you to compare the performance of different trades on an equal footing, regardless of the instrument's volatility or the trade's size.

### 2. Analyzing MFE (Maximum Favorable Excursion)
By analyzing the distribution of `MFE_R` across all your trades, you can answer questions like, "What is the most profit my strategy typically generates?" or "Is my take-profit target of 3R realistic, or do most of my trades only reach 1.5R?" This is invaluable for optimizing profit targets.

### 3. Analyzing MAE (Maximum Adverse Excursion)
MAE tells you how much "pain" you had to endure for a winning trade. If you find that your winning trades consistently have a high MAE (e.g., 0.8R), it might indicate your stop loss is too tight. Conversely, if MAE is always very low, your stop loss might be too wide, and you could be giving up profit.

### 4. Deep Dive: `DrawdownFromMFE_R`

This is a sophisticated metric for testing trailing stop and other dynamic exit strategies. It measures how much profit a trade gives back *after* it has reached its peak profit.

-   **How it's Calculated**: At every candle, the system knows the highest price the trade has reached so far (the `mfePrice`). It then calculates the difference between that peak price and the current candle's closing price. This difference is then divided by the initial risk to normalize it into an R-multiple.
-   **Example**: Your long trade enters at $100 with a stop at $98 (1R = $2). The price rises to a high of $105 (MFE = 2.5R). On the next candle, it pulls back and closes at $103. The drawdown from the peak is $2 ($105 - $103). The `DrawdownFromMFE_R` for this candle is **1.0R** ($2 drawdown / $2 risk).
-   **Why it's Crucial**: By analyzing the `DrawdownFromMFE_R` for all your winning trades, you can find the optimal distance for a trailing stop. If you see that your best trades often pull back 0.7R before continuing higher, setting a 0.5R trailing stop is likely cutting your winners short. This metric allows you to quantify your strategy's "breathing room" and tailor your exit logic to its specific behavior.

---

## How to Simulate Exit Strategies with Journal Data

### A) Simulating a Trailing Stop

You can use the `DrawdownFromMFE_R` value to write code that simulates a trailing stop strategy.

1.  **Define Your Threshold:** Choose the trailing stop distance you want to test, in R-multiples (e.g., `trailingStopThreshold = 1.0`).
2.  **Iterate the Log:** Loop through the `log` array of a trade, candle by candle.
3.  **Check the Condition:** On each candle, check if `logEntry.DrawdownFromMFE_R >= trailingStopThreshold`.
4.  **Trigger the Exit:** If the condition is true, the simulated trailing stop has been hit. Your simulation would exit the trade on that candle.

### B) Simulating a Manual Stop Loss Adjustment

You can also simulate more complex, conditional stop adjustments, such as moving your stop to breakeven after the trade reaches a certain profit level.

**Scenario:** "When my trade reaches 2R in profit, I move my stop loss to breakeven."

**Simulation Logic:**

1.  **Define Parameters:**
    *   `adjustmentTriggerR_Value = 2.0` (The MFE that must be reached)
    *   `newStopLossR_Value = 0.0` (The new stop position, where 0.0R is breakeven)

2.  **Iterate the Log:** Loop through the `log` array, candle by candle.

3.  **Check the Conditions inside the loop:**
    *   **First, check if the adjustment has been triggered:** `if (currentCandle.MFE_R >= adjustmentTriggerR_Value)`.
    *   **If it has, calculate the required pullback to hit the new stop:**
        `const pullbackToHitNewStop_R = currentCandle.MFE_R - newStopLossR_Value;`
        (For our example, if MFE is 2.5R, the pullback needed to hit breakeven is 2.5R).
    *   **Finally, check if the actual drawdown hits the new stop:**
        `if (currentCandle.DrawdownFromMFE_R >= pullbackToHitNewStop_R)`
        If this is true, the adjusted stop has been hit, and the simulation for this trade ends.

This advanced technique allows you to transform your raw trade data into a powerful backtesting engine for sophisticated exit strategies.
```